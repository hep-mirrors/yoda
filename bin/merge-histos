#! /usr/bin/env python

"""\
%prog [-o outfile] yodafile...

Merge Analysis Objects from multiple YODA files.
"""

import yoda, optparse, operator, itertools

parser = optparse.OptionParser(usage=__doc__)
parser.add_option('-o', '--output', default='-', dest='OUTPUT_FILE')
opts, filenames = parser.parse_args()

# TODO: move to util module
def merge(objects, op=operator.iadd):
    out_objects = {}

    for ob in objects:
        existing = out_objects.get(ob.path)
        if existing:
            op(ob, existing)
        out_objects[ob.path] = ob

    return out_objects

analysisobjects_in = (yoda.readYODA(filename) for filename in filenames)
analysisobjects_out = merge(itertools.chain(*analysisobjects_in))

yoda.writeYODA(analysisobjects_out.values(), opts.OUTPUT_FILE)
